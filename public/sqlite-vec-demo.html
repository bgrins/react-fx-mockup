<!DOCTYPE html>
<html>
  <head>
    <title>SQLite Vec Demo</title>
  </head>
  <body>
    <h1>SQLite Vec Demo with OPFS</h1>
    <div id="output"></div>
    
    <script type="module">
      const output = document.getElementById('output');
      
      function log(message) {
        console.log(message);
        output.innerHTML += `<p>${message}</p>`;
      }

      // Worker-based SQLite with OPFS support
      class SQLiteWorkerDB {
        constructor() {
          this.worker = new Worker('/sqlite-worker.js', { type: 'module' });
          this.messageId = 0;
          this.pendingMessages = new Map();
          
          this.worker.addEventListener('message', (event) => {
            const { id, type, data } = event.data;
            const resolve = this.pendingMessages.get(id);
            if (resolve) {
              this.pendingMessages.delete(id);
              if (type === 'error') {
                resolve.reject(new Error(data.error));
              } else {
                resolve.resolve({ type, data });
              }
            }
          });
        }
        
        async sendMessage(type, data = {}) {
          return new Promise((resolve, reject) => {
            const id = ++this.messageId;
            this.pendingMessages.set(id, { resolve, reject });
            this.worker.postMessage({ type, data, id });
          });
        }
        
        async init(dbName = '/vec-demo.db') {
          return this.sendMessage('init', { dbName });
        }
        
        async exec(sql) {
          const result = await this.sendMessage('exec', { sql });
          return result.data.result;
        }
        
        async selectArray(sql) {
          const result = await this.sendMessage('selectArray', { sql });
          return result.data.result;
        }
        
        async selectArrays(sql) {
          const result = await this.sendMessage('selectArrays', { sql });
          return result.data.result;
        }
        
        async close() {
          const result = await this.sendMessage('close');
          this.worker.terminate();
          return result;
        }
      }

      try {
        log('üîÑ Initializing SQLite with OPFS support...');
        const db = new SQLiteWorkerDB();
        
        // Initialize database
        const initResult = await db.init();
        if (initResult.type === 'success') {
          log('‚úÖ Successfully created OPFS database');
        } else if (initResult.type === 'fallback') {
          log('‚ö†Ô∏è ' + initResult.data.message);
        }

        // Test vec_version
        try {
          const result = await db.selectArray('select vec_version() as version');
          const vec_version = result[0];
          log(`‚úÖ vec_version: ${vec_version}`);
        } catch (e) {
          log('‚ùå Failed to get vec_version: ' + e.message);
        }

        // Test basic vector operations
        try {
          await db.exec(`
            CREATE TABLE IF NOT EXISTS test_vectors(
              id INTEGER PRIMARY KEY,
              embedding BLOB
            );
          `);
          
          await db.exec(`
            INSERT INTO test_vectors(embedding) 
            VALUES (vec_f32('[1, 2, 3]')), (vec_f32('[4, 5, 6]'));
          `);
          
          const vectors = await db.selectArrays(`
            SELECT id, vec_to_json(embedding) as embedding 
            FROM test_vectors
          `);
          
          log(`‚úÖ Created and inserted vectors: ${JSON.stringify(vectors)}`);
          
          // Test vector similarity
          const similarities = await db.selectArrays(`
            SELECT 
              a.id as id_a, 
              b.id as id_b,
              vec_distance_cosine(a.embedding, b.embedding) as cosine_distance
            FROM test_vectors a, test_vectors b 
            WHERE a.id < b.id
          `);
          
          log(`‚úÖ Vector similarities: ${JSON.stringify(similarities)}`);
          
        } catch (e) {
          log('‚ùå Vector operations failed: ' + e.message);
        }
        
        await db.close();
        log('‚úÖ Database closed successfully');
        
      } catch (e) {
        log('‚ùå Initialization failed: ' + e.message);
      }
    </script>
  </body>
</html>